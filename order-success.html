<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pesanan Berhasil - Dazeon Store</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

    <script>
        tailwind.config = { theme: { extend: { fontFamily: { sans: ['Poppins', 'sans-serif'] } } } }
    </script>
</head>

<body class="bg-gray-100 font-sans">

    <header class="bg-white shadow-sm">
        <div class="container mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-6 flex justify-center items-center">
            <a href="index.html" class="text-3xl font-black text-gray-900 uppercase tracking-wider">DAZEON</a>
        </div>
    </header>

    <main class="container mx-auto max-w-3xl px-4 sm:px-6 lg:px-8 py-16 text-center">

        <div class="bg-white p-8 sm:p-12 rounded-lg shadow-lg">

            <div
                class="w-24 h-24 bg-green-100 text-green-600 flex items-center justify-center rounded-full mx-auto animate-bounce">
                <i class="fas fa-check text-5xl"></i>
            </div>

            <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 mt-8">
                Pesanan Berhasil!
            </h1>
            <p class="text-lg text-gray-600 mt-4 max-w-lg mx-auto">
                Terima kasih telah berbelanja. Pesanan Anda telah kami terima dan akan segera diproses.
            </p>

            <div class="text-left bg-gray-50 rounded-lg p-6 mt-10 border border-gray-200">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Detail Pesanan</h2>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Nomor Pesanan:</span>
                        <span id="order-id" class="font-bold text-gray-900">Memuat...</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Total Pembayaran:</span>
                        <span id="total-payment" class="font-bold text-gray-900">Memuat...</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Status Pembayaran:</span>
                        <span id="status-badge" class="font-medium text-green-600">Berhasil / Menunggu Verifikasi</span>
                    </div>
                </div>
            </div>

            <div class="text-center mt-8 p-4 bg-blue-50 text-blue-800 rounded-lg">
                <p>
                    Jika status pembayaran Anda belum berubah, silakan cek kembali nanti di halaman <b>Pesanan Saya</b>.
                </p>
            </div>

            <div class="mt-10 flex flex-col sm:flex-row justify-center gap-4">
                <a href="index.html"
                    class="w-full sm:w-auto px-8 py-3 bg-gray-900 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 transition-colors">
                    Kembali ke Beranda
                </a>
                <a href="my-orders.html"
                    class="w-full sm:w-auto px-8 py-3 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition-colors">
                    Lihat Pesanan Saya
                </a>
            </div>

        </div>
    </main>

    <script>
        /*
         * ===============================================
         * KONEKTOR SUPABASE - HALAMAN SUKSES (ORDER-SUCCESS.JS)
         * ===============================================
         */

        // 1. Inisialisasi Supabase (dari config.js)
        const client = window.db;
        if (!client) console.error("Supabase client not found. Ensure config.js is loaded.");

        // 2. Tangkap Elemen
        const orderIdElem = document.getElementById('order-id');
        const totalPaymentElem = document.getElementById('total-payment');
        // Tangkap elemen badge status juga
        const statusBadgeElem = document.getElementById('status-badge');

        // 3. Fungsi untuk Ambil Detail Pesanan
        async function loadOrderDetails() {
            // Ambil ID pesanan dari URL (yang dikirim oleh checkout.js)
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('id');

            if (!orderId) {
                console.error('Order ID tidak ditemukan di URL');
                // Tampilkan pesan user friendly bahwa ID tidak ada, mungkin akses langsung
                document.querySelector('main').innerHTML = `
                    <div class="bg-white p-8 rounded-lg shadow-lg">
                        <div class="text-yellow-500 mb-4"><i class="fas fa-exclamation-triangle text-5xl"></i></div>
                        <h1 class="text-2xl font-bold text-gray-900">Data Pesanan Tidak Ditemukan</h1>
                        <p class="text-gray-600 mt-2">Sepertinya Anda mengakses halaman ini secara langsung atau terjadi kesalahan saat memuat data pesanan.</p>
                        <a href="my-orders.html" class="inline-block mt-6 px-6 py-3 bg-brand text-white font-bold rounded-lg">Lihat Pesanan Saya</a>
                    </div>
                `;
                return;
            }

            // Cek user login
            const { data: { session } } = await client.auth.getSession();
            if (!session) {
                // Seharusnya user masih login, tapi jika tidak, arahkan ke login
                window.location.href = 'index.html?login=true';
                return;
            }

            try {
                // Ambil data dari tabel 'orders'
                let { data: order, error } = await client
                    .from('orders')
                    .select('id, total_amount, status') // Ambil total & status
                    .eq('id', orderId)
                    .eq('user_id', session.user.id) // Pastikan ini pesanan dia
                    .single();

                if (error) throw error;

                if (order) {
                    // Tampilkan data ke HTML
                    if (orderIdElem) orderIdElem.innerText = `DZ-${String(order.id).padStart(4, '0')}`;
                    if (totalPaymentElem) totalPaymentElem.innerText = `Rp${order.total_amount.toLocaleString('id-ID')}`;

                    // Update Status Badge dengan helper function
                    updateStatusBadge(order.status);

                } else {
                    throw new Error('Pesanan tidak ditemukan.');
                }

            } catch (error) {
                console.error('Gagal memuat detail pesanan:', error.message);
                document.querySelector('main').innerHTML = `
                    <div class="bg-white p-8 rounded-lg shadow-lg">
                         <div class="text-red-500 mb-4"><i class="fas fa-times-circle text-5xl"></i></div>
                        <h1 class="text-2xl font-bold text-gray-900">Gagal Memuat Pesanan</h1>
                        <p class="text-gray-600 mt-2">${error.message}</p>
                        <a href="my-orders.html" class="inline-block mt-6 px-6 py-3 bg-gray-800 text-white font-bold rounded-lg">Kembali ke Pesanan Saya</a>
                    </div>
                `;
            }
        }

        // 4. Jalankan Fungsi Saat Halaman Dimuat
        document.addEventListener('DOMContentLoaded', () => {
            loadOrderDetails();

            // --- Eager Status Check ---
            // Cek status ke backend Midtrans menggunakan ID yang disimpan di checkout.js

            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('id');
            const midtransId = localStorage.getItem('last_midtrans_id');

            // Hanya cek jika midtransId ada dan sesuai dengan orderId yang sedang dilihat
            if (midtransId && orderId && midtransId.startsWith(orderId + '-')) {
                console.log("Checking status for Midtrans ID:", midtransId);
                fetch(`http://localhost:3000/api/payment/${midtransId}`)
                    .then(res => res.json())
                    .then(data => {
                        console.log("Eager Status Result:", data);
                        // Jika status settle/capture, beritahu user (UI akan update via Realtime atau reload)
                        if (data.transaction_status === 'settlement' || data.transaction_status === 'capture') {
                            // Opsional: Langsung update UI sebelum Realtime masuk
                            updateStatusBadge('dikemas');
                        }
                    })
                    .catch(err => console.error("Eager check failed:", err));
            }

            // --- Realtime Subscription ---
            if (orderId && client) {
                console.log(`Subscribing to realtime updates for Order ID: ${orderId}`);

                const channel = client
                    .channel('public:orders')
                    .on(
                        'postgres_changes',
                        {
                            event: 'UPDATE',
                            schema: 'public',
                            table: 'orders',
                            filter: `id=eq.${orderId}`
                        },
                        (payload) => {
                            console.log('Order Updated:', payload);
                            const newStatus = payload.new.status;
                            updateStatusBadge(newStatus);

                            // Tampilkan notifikasi toast jika Swall tersedia
                            if (typeof Swal !== 'undefined') {
                                const Toast = Swal.mixin({
                                    toast: true,
                                    position: 'top-end',
                                    showConfirmButton: false,
                                    timer: 3000
                                });
                                Toast.fire({
                                    icon: 'info',
                                    title: 'Status pesanan diperbarui!'
                                });
                            }
                        }
                    )
                    .subscribe();
            }
        });

        function updateStatusBadge(status) {
            const statusMap = {
                'menunggu_pembayaran': { text: 'Menunggu Pembayaran', class: 'text-yellow-600' },
                'menunggu_verifikasi': { text: 'Menunggu Verifikasi', class: 'text-yellow-600' },
                'dikemas': { text: 'Sedang Dikemas', class: 'text-blue-600' },
                'dikirim': { text: 'Sedang Dikirim', class: 'text-blue-600' },
                'selesai': { text: 'Selesai', class: 'text-green-600' },
                'dibatalkan': { text: 'Dibatalkan', class: 'text-red-600' },
                // Default fallback
                'default': { text: status, class: 'text-gray-600' }
            };
            const statusInfo = statusMap[status] || statusMap['default'];

            const statusBadgeElem = document.getElementById('status-badge');
            if (statusBadgeElem) {
                // Reset class dasar lalu tambah class baru. 
                // Karena kita pakai Tailwind classes di HTML, kita replace saja full className
                // Tapi kita harus ingat class layoutnya (font-medium), jadi kita concat.
                statusBadgeElem.className = `font-medium ${statusInfo.class}`;
                statusBadgeElem.innerText = statusInfo.text;
            }
        }
    </script>

</body>

</html>
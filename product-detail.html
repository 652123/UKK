<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail Produk</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>tailwind.config = { theme: { extend: { fontFamily: { sans: ['Poppins', 'sans-serif'] } } } }</script>
    <style>
        .size-btn.active { @apply bg-gray-900 text-white border-gray-900; }
        /* Style tabel spesifikasi */
        .spec-table td { @apply py-2 px-2 text-sm; }
        .spec-table td:first-child { @apply text-gray-500 w-40; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

    <nav class="sticky top-0 z-50 bg-white shadow-sm h-16 flex items-center justify-between px-6 lg:px-16">
        <a href="index.html" class="text-2xl font-black text-gray-900 tracking-wider">DAZEON</a>
        <div class="flex items-center gap-6">
            <a href="index.html" class="text-sm font-medium text-gray-500 hover:text-gray-900">Beranda</a>
            <a href="cart.html" class="relative text-gray-600 hover:text-gray-900">
                <i class="fas fa-shopping-cart text-xl"></i>
                <span id="cart-count" class="absolute -top-2 -right-2 bg-red-600 text-white text-[10px] font-bold rounded-full w-5 h-5 flex items-center justify-center">0</span>
            </a>
        </div>
    </nav>

    <main class="container mx-auto px-4 py-8 max-w-6xl min-h-screen">
        
        <div class="text-sm text-gray-500 mb-6">
            <a href="index.html" class="hover:text-gray-900">Beranda</a> / 
            <a href="index.html#produk" class="hover:text-gray-900">Produk</a> / 
            <span class="text-gray-900 font-medium">Detail</span>
        </div>

        <div id="loading-ui" class="text-center py-20 bg-white rounded-xl">
            <i class="fas fa-circle-notch fa-spin text-4xl text-gray-300"></i>
            <p class="mt-4 text-gray-500">Memuat detail produk...</p>
        </div>

        <div id="product-content" class="hidden">
            
            <div class="bg-white p-6 md:p-8 rounded-xl shadow-sm border border-gray-100">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                    
                    <div class="space-y-4">
                        <div class="aspect-square bg-gray-100 rounded-lg overflow-hidden border">
                            <img id="p-img" src="" alt="Produk" class="w-full h-full object-cover">
                        </div>
                    </div>

                    <div>
                        <h1 id="p-name" class="text-2xl md:text-3xl font-bold text-gray-900 mb-2">Nama Produk</h1>
                        
                        <div class="flex items-center gap-4 mb-6">
                            <p id="p-price" class="text-3xl font-bold text-red-600">Rp0</p>
                            <span class="bg-red-100 text-red-600 text-xs font-bold px-2 py-1 rounded">TERLARIS</span>
                        </div>

                        <div class="bg-gray-50 p-4 rounded-lg mb-6 text-sm text-gray-600 space-y-2">
                            <div class="flex"><span class="w-32 text-gray-500">Bahan</span> <span class="font-medium text-gray-800">Cotton Combed 24s</span></div>
                            <div class="flex"><span class="w-32 text-gray-500">Stok</span> <span class="font-medium text-gray-800" id="p-stock">0</span></div>
                            <div class="flex"><span class="w-32 text-gray-500">Dikirim Dari</span> <span class="font-medium text-gray-800">Jakarta</span></div>
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-bold text-gray-700 mb-2">Pilih Ukuran:</label>
                            <div id="size-options" class="flex flex-wrap gap-3">
                                <button onclick="selectSize(this, 'S')" class="size-btn border rounded px-4 py-2 hover:border-gray-900 transition">S</button>
                                <button onclick="selectSize(this, 'M')" class="size-btn border rounded px-4 py-2 hover:border-gray-900 transition">M</button>
                                <button onclick="selectSize(this, 'L')" class="size-btn border rounded px-4 py-2 hover:border-gray-900 transition">L</button>
                                <button onclick="selectSize(this, 'XL')" class="size-btn border rounded px-4 py-2 hover:border-gray-900 transition">XL</button>
                                <button onclick="selectSize(this, 'XXL')" class="size-btn border rounded px-4 py-2 hover:border-gray-900 transition">XXL</button>
                            </div>
                            <p id="size-alert" class="text-red-500 text-xs mt-2 hidden">Silakan pilih ukuran terlebih dahulu.</p>
                        </div>

                        <div class="flex flex-col sm:flex-row gap-4 mt-8">
                            <div class="flex items-center border rounded-lg w-fit h-12">
                                <button onclick="updateQty(-1)" class="px-4 text-gray-500 hover:bg-gray-100 h-full">-</button>
                                <input id="qty-input" type="text" value="1" class="w-12 text-center border-none focus:ring-0 font-bold" readonly>
                                <button onclick="updateQty(1)" class="px-4 text-gray-500 hover:bg-gray-100 h-full">+</button>
                            </div>
                            <button onclick="addToCart()" id="btn-cart" class="flex-1 bg-gray-900 text-white font-bold h-12 rounded-lg hover:bg-gray-800 transition flex items-center justify-center gap-2">
                                <i class="fas fa-cart-plus"></i> Masukkan Keranjang
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 md:p-8 rounded-xl shadow-sm border border-gray-100 mt-6">
                <h3 class="bg-gray-50 p-4 font-bold text-lg text-gray-900 mb-6 border-l-4 border-gray-900">Deskripsi Produk</h3>
                
                <div class="prose max-w-none text-gray-700 text-sm leading-relaxed space-y-6">
                    
                    <p>
                        Produk kami terbuat dari <strong>100% Cotton Combed 24s Premium</strong>. Bahannya tebal namun tetap lembut, adem, menyerap keringat, dan sangat nyaman dipakai untuk aktivitas sehari-hari.
                    </p>

                    <div>
                        <h4 class="font-bold text-gray-900 mb-2">Spesifikasi Kaos:</h4>
                        <ul class="list-disc pl-5 space-y-1">
                            <li>Bahan: Cotton Combed 24s (Lebih tebal dari 30s).</li>
                            <li>Sablon: Direct Transfer Film (DTF) - Hasil detail, awet, dan tidak pecah.</li>
                            <li>Model Leher: O-Neck.</li>
                            <li>Jahitan: Pundak Rantai & Stick Leher (Standar Distro).</li>
                            <li>Pola: Regular Fit / Oversize (Sesuai varian).</li>
                        </ul>
                    </div>

                    <div>
                        <h4 class="font-bold text-gray-900 mb-2">Catatan Tambahan:</h4>
                        <p id="p-desc" class="whitespace-pre-line text-gray-600">
                            </p>
                    </div>

                    <div>
                        <h4 class="font-bold text-gray-900 mb-3">Panduan Ukuran (Size Chart):</h4>
                        <div class="overflow-x-auto">
                            <table class="w-full max-w-md text-left text-sm border">
                                <thead class="bg-gray-100 font-bold">
                                    <tr>
                                        <th class="p-3 border">Ukuran</th>
                                        <th class="p-3 border">Panjang (cm)</th>
                                        <th class="p-3 border">Lebar (cm)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="border-b"><td class="p-3 border">S</td><td class="p-3 border">68</td><td class="p-3 border">46</td></tr>
                                    <tr class="border-b"><td class="p-3 border">M</td><td class="p-3 border">70</td><td class="p-3 border">48</td></tr>
                                    <tr class="border-b"><td class="p-3 border">L</td><td class="p-3 border">72</td><td class="p-3 border">50</td></tr>
                                    <tr class="border-b"><td class="p-3 border">XL</td><td class="p-3 border">74</td><td class="p-3 border">52</td></tr>
                                    <tr><td class="p-3 border">XXL</td><td class="p-3 border">76</td><td class="p-3 border">54</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">*Toleransi ukuran 1-2 cm karena proses jahit.</p>
                    </div>

                    <p class="font-bold text-gray-900 pt-4">Happy Shopping!</p>
                </div>
            </div>

        </div>
    </main>

    <script>
        const SUPABASE_URL = 'https://vatlrekidlsxtvxoaegn.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZhdGxyZWtpZGxzeHR2eG9hZWduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyODc3NTIsImV4cCI6MjA3Njg2Mzc1Mn0.4ZrBuQDO-dspKY72lquNuGn5BisUChJwBxtKPD0aKE0';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentProduct = null;
        let selectedSize = null;
        let currentUserId = null;

        // INIT
        async function init() {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');

            if (!id) {
                alert("Produk tidak ditemukan.");
                window.location.href = 'index.html';
                return;
            }

            try {
                // Fetch Produk
                const { data, error } = await supabase.from('products').select('*').eq('id', id).single();
                if (error || !data) throw new Error("Gagal mengambil data");

                currentProduct = data;
                renderUI(data);
                checkUser();

            } catch (err) {
                console.error(err);
                document.getElementById('loading-ui').innerHTML = "<p class='text-red-500'>Gagal memuat produk.</p>";
            }
        }

        // RENDER UI
        function renderUI(p) {
            document.getElementById('loading-ui').classList.add('hidden');
            document.getElementById('product-content').classList.remove('hidden');

            document.getElementById('p-name').innerText = p.name;
            document.getElementById('p-price').innerText = `Rp${p.price.toLocaleString('id-ID')}`;
            document.getElementById('p-stock').innerText = p.stock;
            document.getElementById('p-desc').innerText = p.description || "-";

            // Image
            const imgUrl = p.image_url ? 
                supabase.storage.from('product-images').getPublicUrl(p.image_url).data.publicUrl : 
                'https://via.placeholder.com/400';
            document.getElementById('p-img').src = imgUrl;

            // Stok Logic
            const qtyInput = document.getElementById('qty-input');
            const btnCart = document.getElementById('btn-cart');
            
            if (p.stock < 1) {
                btnCart.disabled = true;
                btnCart.innerText = "Stok Habis";
                btnCart.classList.add('opacity-50', 'cursor-not-allowed');
                qtyInput.value = 0;
            }
        }

        // INTERACTION
        window.selectSize = (btn, size) => {
            document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedSize = size;
            document.getElementById('size-alert').classList.add('hidden');
        };

        window.updateQty = (change) => {
            const input = document.getElementById('qty-input');
            let val = parseInt(input.value) + change;
            if (val >= 1 && val <= currentProduct.stock) input.value = val;
        };

        window.addToCart = async () => {
            if (!currentUserId) return alert("Silakan login dulu.");
            if (!selectedSize) {
                document.getElementById('size-alert').classList.remove('hidden');
                return;
            }

            const btn = document.getElementById('btn-cart');
            const originalText = btn.innerHTML;
            btn.innerText = "Memproses...";
            btn.disabled = true;

            try {
                const qty = parseInt(document.getElementById('qty-input').value);
                
                // Cek Item di Cart
                const { data: exist } = await supabase.from('cart_items')
                    .select('*')
                    .eq('user_id', currentUserId)
                    .eq('product_id', currentProduct.id)
                    .eq('size', selectedSize)
                    .maybeSingle();

                if (exist) {
                    await supabase.from('cart_items').update({ quantity: exist.quantity + qty }).eq('id', exist.id);
                } else {
                    await supabase.from('cart_items').insert([{
                        user_id: currentUserId,
                        product_id: currentProduct.id,
                        quantity: qty,
                        size: selectedSize
                    }]);
                }

                alert("Berhasil masuk keranjang!");
                window.location.href = 'cart.html';

            } catch (err) {
                alert("Gagal: " + err.message);
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        };

        async function checkUser() {
            const { data } = await supabase.auth.getSession();
            if (data.session) {
                currentUserId = data.session.user.id;
                const { data: cart } = await supabase.from('cart_items').select('quantity').eq('user_id', currentUserId);
                if(cart) {
                    const total = cart.reduce((a, b) => a + b.quantity, 0);
                    document.getElementById('cart-count').innerText = total;
                }
            }
        }

        init();
    </script>
</body>
</html>